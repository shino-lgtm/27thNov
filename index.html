<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ - My Firestore App</title>
    <style>
        /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° (PCå‘ã‘/å…±é€š) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ (PCç”¨ã®æ ) */
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* åŸ‹ã‚è¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #instagram-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }
        #instagram-section h2 {
            color: #0ABAB5;
            margin-bottom: 25px;
            font-weight: 600;
        }
        /* åŸ‹ã‚è¾¼ã¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚³ãƒ³ãƒ†ãƒŠå¹…ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
        #instagram-embed-content {
            max-width: 100%; 
            overflow: hidden;
            display: inline-block; /* ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ */
        }
        /* Instagramã®åŸ‹ã‚è¾¼ã¿ãƒ–ãƒ­ãƒƒã‚¯quoteè‡ªä½“ãŒãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã«å¯¾å¿œã™ã‚‹ãŸã‚ã®èª¿æ•´ */
        .instagram-media {
            min-width: 300px !important; /* ã‚¹ãƒãƒ›ã§å°ã•ããªã‚Šã™ããªã„ã‚ˆã†ã« */
            width: 100% !important;
        }

        /* å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        #fixed-header {
            position: sticky; 
            top: 0;
            z-index: 1000;
            background-color: #ffffff;
            padding-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #00A3A0; 
            text-align: center;
            margin-top: 10px;
            margin-bottom: 15px; 
            font-weight: 600;
        }
        
        /* èªè¨¼UIã®ã‚¹ã‚¿ã‚¤ãƒ« (çœç•¥) */
        #auth-ui { text-align: right; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        #login-button, #logout-button, #mypage-button, #all-events-button { padding: 6px 12px; margin-left: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: background-color 0.2s; }
        #login-button { background-color: #0ABAB5; color: white; }
        #login-button:hover { background-color: #00A3A0; }
        #logout-button { background-color: #fbbc05; color: #333; }
        #logout-button:hover { background-color: #e0ac03; }
        #mypage-button, #all-events-button { background-color: #00A3A0; color: white; font-weight: bold; }
        #mypage-button:hover, #all-events-button:hover { background-color: #008f8c; }
        .view-active { background-color: #0ABAB5 !important; box-shadow: 0 0 0 2px #E0FFFF; }
        
        /* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« (çœç•¥) */
        #search-controls { display: flex; gap: 10px; margin-bottom: 10px; padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        #search-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
        #search-button, #clear-button { padding: 8px 12px; color: white; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; transition: background-color 0.2s ease; }
        #search-button { background-color: #00A3A0; }
        #search-button:hover { background-color: #008f8c; }
        #clear-button { background-color: #fbbc05; white-space: nowrap; }
        #clear-button:hover { background-color: #e0ac03; }
        
        /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« (çœç•¥) */
        #tag-list { padding: 5px 0 15px 0; margin-bottom: 10px; border-bottom: 1px solid #eee; overflow-x: auto; white-space: nowrap; }
        .tag-button { background-color: #e0e0e0; color: #333; border: 1px solid #ccc; padding: 4px 10px; margin-right: 6px; margin-bottom: 6px; border-radius: 18px; font-size: 0.8em; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; display: inline-block; }
        .tag-button:hover { background-color: #d0d0d0; }
        .tag-button.active { background-color: #0ABAB5; color: white; border-color: #0ABAB5; font-weight: bold; }

        /* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« (çœç•¥) */
        #events-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .event-card { background-color: #E0FFFF; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); transition: transform 0.2s ease-in-out; position: relative; }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .event-card .event-image { max-width: 100%; height: auto; border-radius: 5px; margin-bottom: 15px; display: block; }
        .event-card h2 { color: #0ABAB5; margin-top: 0; font-size: 1.5em; margin-bottom: 10px; }
        .event-card p { margin-bottom: 8px; font-size: 0.95em; }
        .event-card .date { font-weight: bold; color: #34a853; }
        .event-card .location { color: #ea4335; }
        .event-tags { margin-top: 10px; font-size: 0.85em; color: #757575; }
        .event-tag { display: inline-block; background-color: #cccccc; color: #333; padding: 3px 8px; margin-right: 5px; margin-bottom: 5px; border-radius: 4px; }

        /* ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« (çœç•¥) */
        .favorite-button { position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; z-index: 10; user-select: none; transition: transform 0.1s; }
        .favorite-button:hover { transform: scale(1.1); }
        .favorite-button.empty { color: #a0a0a0; }
        .favorite-button.filled { color: #ff4d4d; } 

        .loading-message, .error-message { text-align: center; font-size: 1.1em; margin-top: 20px; padding: 15px; border-radius: 5px; }
        .loading-message { background-color: #fff3cd; color: #856404; }
        .error-message { background-color: #f8d7da; color: #721c24; }
        #loadEventsButton { display: none; }


        /* --- æºå¸¯ç«¯æœ« (å¹…600pxä»¥ä¸‹) ç”¨ã®æœ€é©åŒ–ã‚¹ã‚¿ã‚¤ãƒ« (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ) --- */
        @media (max-width: 600px) {
            body { padding: 5px; }
            .container { margin: 0; padding: 10px; box-shadow: none; }
            #fixed-header { padding: 5px 0 0 0; }
            #events-list { grid-template-columns: 1fr; gap: 15px; }
            #search-controls { flex-direction: column; gap: 8px; margin-bottom: 5px; padding: 8px; }
            #search-button, #clear-button { width: 100%; box-sizing: border-box; }
            #auth-ui { text-align: center; margin-bottom: 5px; }
            #auth-ui button, #auth-ui span { margin: 3px 3px; display: inline-block; font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="fixed-header">
            <div id="auth-ui">
                <button id="all-events-button" class="view-active">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</button>
                <button id="mypage-button">ãŠæ°—ã«å…¥ã‚Š</button>
                
                <span id="user-status">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚</span>
                <button id="login-button">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="logout-button" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            
            <h1 id="main-title">ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ</h1> 
            <div id="search-controls">
                <input type="text" id="search-input" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦çµã‚Šè¾¼ã¿ (ä¾‹: æ±äº¬, AI)">
                <button id="search-button">æ¤œç´¢</button>
                <button id="clear-button" title="æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢ã—ã¦å…¨ä»¶è¡¨ç¤º">ã‚¯ãƒªã‚¢</button>
            </div>

            <div id="tag-list">
                </div>
        </div>
        
        <div id="events-list">
            <p class="loading-message" id="initial-message">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
        </div>

        <div id="instagram-section">
            <h2>æœ€æ–°ã®InstagramæŠ•ç¨¿</h2>
            <div id="instagram-embed-content">
                <blockquote class="instagram-media" data-instgrm-captioned data-instgrm-permalink="https://www.instagram.com/p/DSPo1egEz0f/" data-instgrm-version="14" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:540px; min-width:326px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:16px;"> <a href="https://www.instagram.com/p/DSPo1egEz0f/" style=" background:#FFFFFF; line-height:0; padding:0 0; text-align:center; text-decoration:none; width:100%;" target="_blank"> <div style=" display: flex; flex-direction: row; align-items: center;"></div><div style="padding: 19% 0;"></div> <div style="display:block; height:50px; margin:0 auto; width:50px;"><svg width="50px" height="50px" viewBox="0 0 60 60" version="1.1" xmlns="https://www.w3.org/2000/svg" xmlns:xlink="https://www.w3.org/1999/xlink"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-511.000000, -20.000000)" fill="#000000"><g><path d="M556.869,30.41 C554.814,30.41 553.148,32.076 553.148,34.131 C553.148,36.186 554.814,37.852 556.869,37.852 C558.924,37.852 560.59,36.186 560.59,34.131 C560.59,32.076 558.924,30.41 556.869,30.41 M541,60.657 C535.115,60.657 530.342,55.887 530.342,50 C530.342,44.114 535.115,39.342 541,39.342 C546.885,39.342 551.658,44.114 551.658,50 C551.658,55.887 546.885,60.657 541,60.657 M541,33.886 C532.172,33.886 524.886,41.172 524.886,50 C524.886,58.828 532.172,66.114 541,66.114 C549.828,66.114 557.114,58.828 557.114,50 C557.114,41.172 549.828,33.886 541,33.886 M565.378,62.101 C566.068,62.101 566.83,62.158 567.652,62.274 C568.537,62.404 569.373,62.545 570.106,62.808 C570.66,63.029 571.187,63.268 571.697,63.551 C572.247,63.855 572.768,64.218 573.292,64.672 C574.457,65.748 575.059,67.147 575.322,69.176 C575.602,71.229 575.617,73.456 575.46,75.474 C575.312,77.426 575.029,79.526 574.604,81.332 C574.07,83.475 573.1,85.127 571.979,86.467 C570.923,87.81 569.314,88.384 566.974,88.65 C565.343,88.835 563.468,88.889 561.42,88.756 C559.865,88.649 557.915,88.423 556.24,88.082 C555.457,87.923 554.77,87.728 554.108,87.5 C552.887,87.063 551.691,86.539 550.603,85.922 C550.089,85.631 549.566,85.32 549.043,84.992 C548.156,84.42 547.454,83.921 546.75,83.242 C545.897,82.41 545.247,81.189 544.88,79.088 C544.529,77.108 544.551,74.795 544.707,72.47 C544.857,70.198 545.195,68.086 545.643,66.191 C546.107,64.331 546.857,62.83 548.113,61.597 C549.278,60.444 550.844,59.855 553.148,59.601 C554.674,59.431 556.333,59.399 557.92,59.431 C560.038,59.472 562.036,59.58 563.666,59.855 C564.444,59.988 565.334,60.183 566.279,60.428 C567.039,60.627 567.824,60.852 568.618,61.169 C569.499,61.523 570.472,62.013 571.491,62.668 C572.781,63.5 573.743,64.673 574.209,66.216 C574.677,67.757 574.757,69.606 574.524,71.594 C574.334,73.18 573.916,74.928 573.284,76.549 C572.639,78.229 571.745,79.79 570.613,81.168 C569.467,82.593 567.924,83.332 565.378,83.504 C563.864,83.606 562.062,83.674 559.957,83.674 C558.053,83.674 556.096,83.621 554.192,83.504 C551.464,83.332 549.404,82.384 548.336,81.168 C547.458,80.17 546.908,78.783 546.606,76.603 C546.334,74.792 546.353,72.695 546.467,70.528 C546.592,68.421 546.958,66.425 547.428,64.667 C547.931,62.863 548.66,61.353 549.914,60.17 C551.002,59.135 552.483,58.75 554.498,58.653 C556.326,58.557 558.172,58.588 559.946,58.653 C561.765,58.74 563.633,59.027 565.378,59.601 M556.869,32.228 C554.814,32.228 553.148,33.894 553.148,35.95 C553.148,38.005 554.814,39.671 556.869,39.671 C558.924,39.671 560.59,38.005 560.59,35.95 C560.59,33.894 558.924,32.228 556.869,32.228 M541,41.157 C533.155,41.157 526.886,47.426 526.886,55.27 C526.886,63.115 533.155,69.384 541,69.384 C548.845,69.384 555.114,63.115 555.114,55.27 C555.114,47.426 548.845,41.157 541,41.157" id="Fill-1"></path></g></g></g></svg></div><div style="padding-top: 8px;"> <div style=" color:#3897f0; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:550; line-height:18px;"> View this post on Instagram</div></div><div style="padding: 12.5% 0;"></div> <div style="display: flex; flex-direction: row; margin-bottom: 14px; align-items: center;"><div> <div style="background-color: #F4F4F4; border-radius: 50%; height: 12.5px; width: 12.5px; transform: translateX(1px); margin-right: 7px;"></div> <div style="background-color: #F4F4F4; height: 12.5px; transform: rotate(-45deg) translateX(3px); width: 12.5px; flex-grow: 0; margin-left: 8px;"></div></div> <div style="display: flex; flex-direction: column; flex-grow: 1; justify-content: center; margin-left: 20px;"> <div style=" background-color: #F4F4F4; border-radius: 50%; height: 18px; width: 18px;"></div> <div style=" margin-left: 10px; background-color: #F4F4F4; height: 9px; border-radius: 3px; width: 35px;"></div></div> <div style="display: flex; flex-direction: row; margin: 0 auto;"> <div style=" background-color: #F4F4F4; border-radius: 50%; height: 10px; width: 10px;"></div> <div style=" margin-left: 2px; background-color: #F4F4F4; height: 10px; width: 10px; border-radius: 50%;"></div></div></div> <div style="padding-top: 8px;"> <div style=" color:#3897f0; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:550; line-height:18px;"> A post shared by The Official PokÃ©mon GO Twitter (@pokemongo)</div></div><div style="padding: 12.5% 0;"></div> <p style=" margin:8px 0 0 0; padding:0 4px; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"> <a href="https://www.instagram.com/p/DSPo1egEz0f/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A post shared by The Official PokÃ©mon GO Twitter (@pokemongo)</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2016-11-23T16:20:13+00:00">Nov 23, 2016 at 8:20am PST</time></p></div></blockquote>
                </div>
        </div>
    </div> 

    <script async src="//www.instagram.com/embed.js"></script> 
    <script type="module">
        // Firebase SDKã®å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            orderBy, 
            query, 
            where, 
            doc, 
            setDoc, 
            deleteDoc,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged,
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';


        // --- ã‚ãªãŸã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBH8EPKOwIBIMR16Z7PTECc2Lp0Y5cfkHQ",
            authDomain: "november5th-a1336.firebaseapp.com",
            projectId: "november5th-a1336",
            storageBucket: "november5th-a1336.firebasestorage.app",
            messagingSenderId: "11537951889",
            appId: "1:11537951889:web:d783b2298fc90f88a3a330"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 

        // DOMè¦ç´ ã¸ã®å‚ç…§ã‚’å–å¾—
        const eventsListContainer = document.getElementById('events-list');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const clearButton = document.getElementById('clear-button');
        const tagListContainer = document.getElementById('tag-list');
        const mainTitle = document.getElementById('main-title'); 

        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userStatus = document.getElementById('user-status');
        const mypageButton = document.getElementById('mypage-button');
        const allEventsButton = document.getElementById('all-events-button');


        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªçŠ¶æ…‹ç®¡ç†å¤‰æ•°
        let allEventsCache = []; 
        let currentActiveTag = ''; 
        let favoriteEventIds = new Set(); 
        let currentView = 'all'; 

        // --- èªè¨¼æ©Ÿèƒ½ã®é–¢æ•° (çœç•¥) ---
        async function loginWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error.message);
                alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                favoriteEventIds = new Set();
                currentView = 'all';
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error.message);
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        }
        
        async function fetchFavoriteIds() {
            const userId = auth.currentUser ? auth.currentUser.uid : null;
            if (!userId) {
                favoriteEventIds = new Set();
                return;
            }

            try {
                const favoritesColRef = collection(db, "favorites");
                const q = query(favoritesColRef, where("userId", "==", userId));
                const snapshot = await getDocs(q);
                
                favoriteEventIds = new Set(snapshot.docs.map(doc => doc.data().eventId));
            } catch (error) {
                 console.error("ãŠæ°—ã«å…¥ã‚ŠIDã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                 favoriteEventIds = new Set();
            }
        }
        
        async function toggleFavorite(eventId) {
            const user = auth.currentUser;
            if (!user) {
                alert("ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                return;
            }
            const userId = user.uid;
            
            const docId = `${userId}_${eventId}`;
            const docRef = doc(db, "favorites", docId); 
            
            const isCurrentlyFavorite = favoriteEventIds.has(eventId);
            
            try {
                if (isCurrentlyFavorite) {
                    await deleteDoc(docRef);
                    favoriteEventIds.delete(eventId);
                } else {
                    await setDoc(docRef, {
                        userId: userId,
                        eventId: eventId,
                        createdAt: serverTimestamp() 
                    });
                    favoriteEventIds.add(eventId);
                }
                
                loadEvents(searchInput.value, currentActiveTag);
            } catch (error) {
                console.error("ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãŠæ°—ã«å…¥ã‚Šæ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreã®ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        // --- Firestoreãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»è¡¨ç¤ºé–¢æ•° (çœç•¥) ---
        async function fetchAllEvents() {
            if (allEventsCache.length > 0) { return allEventsCache; }

            try {
                const eventsCollectionRef = collection(db, "events");
                const q = query(eventsCollectionRef, orderBy("date", "asc"));
                const querySnapshot = await getDocs(q);
                
                let eventsData = [];
                let uniqueTags = new Set(); 

                querySnapshot.forEach((doc) => {
                    const eventData = doc.data();
                    eventData.id = doc.id; 
                    eventsData.push(eventData);

                    const tagsArray = Array.isArray(eventData.tags) ? eventData.tags : (typeof eventData.tags === 'string' ? eventData.tags.split(',').map(t => t.trim()) : []);
                    tagsArray.forEach(tag => {
                        const t = tag.trim();
                        if (t) uniqueTags.add(t);
                    });
                });

                allEventsCache = eventsData;
                createTagButtons(Array.from(uniqueTags)); 
                
                return eventsData;
            } catch (error) {
                console.error("ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                eventsListContainer.innerHTML = `<p class="error-message">ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                return [];
            }
        }

        function createTagButtons(tags) {
            tagListContainer.innerHTML = '';
            
            const allButton = document.createElement('button');
            allButton.textContent = "å…¨ã¦";
            allButton.className = 'tag-button';
            allButton.addEventListener('click', () => handleTagClick(""));
            tagListContainer.appendChild(allButton);

            tags.sort().forEach(tag => {
                const button = document.createElement('button');
                button.textContent = tag;
                button.className = 'tag-button';
                button.setAttribute('data-tag', tag);
                button.addEventListener('click', () => handleTagClick(tag));
                tagListContainer.appendChild(button);
            });
            updateTagButtonsUI(currentActiveTag);
        }
        
        function handleTagClick(tag) {
            searchInput.value = '';
            
            const newTag = (currentActiveTag === tag) ? "" : tag;
            currentActiveTag = newTag; 
            
            updateTagButtonsUI(newTag);
            loadEvents(searchInput.value, newTag);
        }

        function updateTagButtonsUI(activeTag) {
            document.querySelectorAll('.tag-button').forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-tag') === activeTag || (!activeTag && button.textContent === "å…¨ã¦")) {
                    button.classList.add('active');
                }
            });
        }
        
        function updateViewButtonsUI() {
            allEventsButton.classList.remove('view-active');
            mypageButton.classList.remove('view-active');
            
            if (currentView === 'all') {
                allEventsButton.classList.add('view-active');
                mainTitle.textContent = "ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ"; 
                tagListContainer.style.display = 'block'; 
                searchButton.style.display = 'inline-block';
                clearButton.style.display = 'inline-block';
            } else {
                mypageButton.classList.add('view-active');
                mainTitle.textContent = "ãŠæ°—ã«å…¥ã‚Š"; 
                tagListContainer.style.display = 'none'; 
                searchButton.style.display = 'none';
                clearButton.style.display = 'none';
            }
            
            const isUserLoggedIn = auth.currentUser !== null;
            mypageButton.style.display = isUserLoggedIn ? 'inline-block' : 'none';
            allEventsButton.style.display = isUserLoggedIn ? 'inline-block' : 'none';
        }


        async function loadEvents(keyword = searchInput.value, selectedTag = currentActiveTag) {
            const lowerCaseKeyword = keyword.trim().toLowerCase();
            const trimSelectedTag = selectedTag.trim();

            updateViewButtonsUI();
            eventsListContainer.innerHTML = '<p class="loading-message">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';
            searchButton.disabled = true;
            clearButton.disabled = true;
            document.querySelectorAll('.tag-button').forEach(b => b.disabled = true);

            const eventsData = await fetchAllEvents();
            if (eventsData.length === 0) {
                 searchButton.disabled = false;
                 clearButton.disabled = false;
                 document.querySelectorAll('.tag-button').forEach(b => b.disabled = false);
                 return;
            }

            // 1. è¤‡åˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const now = new Date();
            now.setHours(0, 0, 0, 0); 
            
            let filteredEvents = eventsData.filter(event => {
                
                // ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (currentView === 'favorites' && !favoriteEventIds.has(event.id)) {
                    return false;
                }
                
                // éå»ã®æ—¥ä»˜ã‚’éè¡¨ç¤º
                const eventDateObj = event.date ? (event.date.toDate ? event.date.toDate() : new Date(event.date)) : null;
                if (!eventDateObj || eventDateObj < now) { return false; }
                
                // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå…¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã§ã®ã¿é©ç”¨ï¼‰
                if (currentView === 'all' && trimSelectedTag) {
                    const eventTags = Array.isArray(event.tags) ? event.tags : (typeof event.tags === 'string' ? event.tags.split(',').map(t => t.trim()) : []);
                    if (!eventTags.includes(trimSelectedTag)) { return false; }
                }
                
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (lowerCaseKeyword) {
                    const title = (event.title || '').toLowerCase();
                    const description = (event.description || '').toLowerCase();
                    const location = (event.location || '').toLowerCase();
                    const tags = Array.isArray(event.tags) ? event.tags.join(' ').toLowerCase() : (event.tags || '').toLowerCase();

                    if (!(title.includes(lowerCaseKeyword) ||
                           description.includes(lowerCaseKeyword) ||
                           location.includes(lowerCaseKeyword) ||
                           tags.includes(lowerCaseKeyword))) { return false; }
                }
                return true;
            });

            // 2. HTMLæç”»
            eventsListContainer.innerHTML = ''; 

            if (filteredEvents.length === 0) {
                let message = currentView === 'favorites' 
                    ? `ãŠæ°—ã«å…¥ã‚Šã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`
                    : `æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                eventsListContainer.innerHTML = `<p class="loading-message">${message}</p>`;
            } else {
                filteredEvents.forEach((eventData) => {
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card';

                    const title = eventData.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
                    const date = eventData.date ? (eventData.date.toDate ? eventData.date.toDate().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }) : eventData.date) : 'æ—¥ä»˜æœªå®š';
                    const description = eventData.description || 'èª¬æ˜ãªã—';
                    const location = eventData.location || 'å ´æ‰€æœªå®š';
                    const imageUrl = eventData.imageUrl || ''; 
                    const eventId = eventData.id; 
                    
                    const isFavorite = favoriteEventIds.has(eventId);
                    const heartIconClass = isFavorite ? 'filled' : 'empty';
                    const heartIcon = isFavorite ? 'â¤ï¸' : 'ğŸ¤'; 
                    
                    let tagsHtml = '';
                    const tagsArray = Array.isArray(eventData.tags) ? eventData.tags : (typeof eventData.tags === 'string' ? eventData.tags.split(',').map(t => t.trim()) : []);
                    if (tagsArray.length > 0) {
                        const tagSpans = tagsArray.map(tag => 
                            `<span class="event-tag">${tag.trim()}</span>`
                        ).join('');
                        tagsHtml = `<div class="event-tags">${tagSpans}</div>`;
                    }

                    eventCard.innerHTML = `
                        ${auth.currentUser ? `<span class="favorite-button ${heartIconClass}" data-event-id="${eventId}">${heartIcon}</span>` : ''}
                        ${imageUrl ? `<img src="${imageUrl}" alt="${title}" class="event-image">` : ''}
                        <h2>${title}</h2>
                        <p class="date">æ—¥ä»˜: ${date}</p>
                        <p><strong>å ´æ‰€:</strong> ${location}</p>
                        <p>${description}</p>
                        ${tagsHtml}
                    `;
                    eventsListContainer.appendChild(eventCard);
                    
                    if (auth.currentUser) {
                        const favButton = eventCard.querySelector('.favorite-button');
                        if (favButton) {
                            favButton.addEventListener('click', (e) => {
                                e.stopPropagation(); 
                                toggleFavorite(eventId);
                            });
                        }
                    }
                });
            }

            searchButton.disabled = false;
            clearButton.disabled = false;
            document.querySelectorAll('.tag-button').forEach(b => b.disabled = false);
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---
        loginButton.addEventListener('click', loginWithGoogle);
        logoutButton.addEventListener('click', signOutUser);

        // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒªã‚¹ãƒŠãƒ¼
        mypageButton.addEventListener('click', () => {
            currentView = 'favorites';
            currentActiveTag = '';
            searchInput.value = '';
            updateTagButtonsUI('');
            loadEvents();
        });

        allEventsButton.addEventListener('click', () => {
            currentView = 'all';
            currentActiveTag = '';
            searchInput.value = '';
            updateTagButtonsUI('');
            loadEvents();
        });

        searchButton.addEventListener('click', () => {
            currentView = 'all'; 
            currentActiveTag = "";
            updateTagButtonsUI("");
            loadEvents(searchInput.value, "");
        });

        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            currentActiveTag = "";
            updateTagButtonsUI("");
            loadEvents('', "");
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchButton.click();
            }
        });
        
        onAuthStateChanged(auth, async (user) => {
            const isUserLoggedIn = user !== null;
            
            if (user) {
                userStatus.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName || user.email}`;
                loginButton.style.display = 'none';
                logoutButton.style.display = 'inline-block';
                
                await fetchFavoriteIds();
            } else {
                userStatus.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚';
                loginButton.style.display = 'inline-block';
                logoutButton.style.display = 'none';
            }
            
            updateViewButtonsUI();

            if (allEventsCache.length === 0 || isUserLoggedIn) {
                fetchAllEvents().then(() => {
                    loadEvents(); 
                });
            } else {
                loadEvents();
            }
        });
    </script>
</body>
</html>
