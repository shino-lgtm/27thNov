<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, deleteDoc, setDoc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // ⚠️重要：ここをご自身のFirebase設定に必ず書き換えてください！
    const firebaseConfig = {
        apiKey: "AIzaSyBH8EPKOwIBIMR16Z7PTECc2Lp0Y5cfkHQ",
        authDomain: "november5th-a1336.firebaseapp.com",
        projectId: "november5th-a1336",
        storageBucket: "november5th-a1336.firebasestorage.app",
        messagingSenderId: "11537951889",
        appId: "1:11537951889:web:d783b2298fc90f88a3a330"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let allEvents = [];
    let favIds = new Set();
    let currentView = 'all';
    let activeTag = '';
    const WORKER_URL = "https://patient-voice-9171.k-93b.workers.dev";

    // 一覧表示のメイン関数（ここが動かないと読み込み中になります）
    async function fetchEvents() {
        try {
            const snap = await getDocs(collection(db, "events"));
            allEvents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // お気に入りデータの取得
            if (auth.currentUser) {
                const fSnap = await getDocs(collection(db, "favorites"));
                favIds = new Set(fSnap.docs.filter(d => d.data().userId === auth.currentUser.uid).map(d => d.data().eventId));
            }
            
            renderTags();
            renderEvents();
            renderCalendars(allEvents); // これを最後に持ってくるのがコツです
        } catch (err) {
            console.error("Firebaseエラー:", err);
            document.getElementById('events-list').innerText = "エラー：Firebaseの接続を確認してください。";
        }
    }

    // カレンダー描画（エラー回避版）
    function renderCalendars(events) {
        const calEvents = events.map(e => ({ 
            title: e.title, 
            start: (e.date?.toDate ? e.date.toDate() : new Date(e.date)).toISOString().split('T')[0],
            backgroundColor: '#00A3A0', 
            borderColor: '#00A3A0' 
        }));

        const calNowEl = document.getElementById('calendar-now');
        if (calNowEl) {
            new FullCalendar.Calendar(calNowEl, { 
                initialView: 'dayGridMonth', // Gを大文字に修正
                locale: 'ja', 
                height: 'auto', 
                events: calEvents,
                headerToolbar: { left: '', center: 'title', right: '' }
            }).render();
        }
        // ...（翌月分も同様に修正）
    }

    // （他の showDetail や runTopAi などの関数はそのまま残してください）

    // ログイン状態が変わったらデータを読み込む
    onAuthStateChanged(auth, (user) => {
        const statusEl = document.getElementById('user-status');
        if(statusEl) statusEl.textContent = user ? user.displayName : 'Guest';
        document.getElementById('login-button').style.display = user ? 'none' : 'inline-block';
        document.getElementById('logout-button').style.display = user ? 'inline-block' : 'none';
        fetchEvents(); // ここで読み込み開始！
    });

    // ...（ボタンのクリックイベントなど）
</script>
